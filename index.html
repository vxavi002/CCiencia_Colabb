---
title: "Atividade Final_Ci√™ncia Colab"
author: "Vanessa Xavier"
date: "22/10/2021"
output:
  html_document:
    theme: cerulean
    code_folding: "show"
    toc: true
    toc_float: true
    number_sections: false
---

```{=html}
<style>

body {text-align:justify}

</style>
```
```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy(position = c("top", "right"),
  color = "auto",
  tooltip_message = "Copy code",
  tooltip_success = "Copied!")
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# ***Pseudobombax grandiflorum*** **(Cav.) A. Robyns**

*Pseudobombax grandiflorum* (Cav.) A. Robyns pertence √† fam√≠lia Malvaceae e √© popularmente conhecida como embiru√ßu. A esp√©cie apresenta porte arb√≥reo com car√°ter dec√≠duo e apresenta flores atrativas sendo considerada ornamental (Carvalho, 2008). Al√©m disso, a esp√©cie tem ampla distribui√ß√£o e est√° presente em *inselbergs*, vegeta√ß√£o de restingas, al√©m de florestas estacionais e ombr√≥filas, apresentando uma alta plasticidade fenot√≠pica (Sultan, 2003).

Nesta atividade iremos acessar o banco de dados do GBIF para obter informa√ß√µes de distribui√ß√£o e ocorr√™ncias dessa esp√©cie atrav√©s do software R, plotar alguns gr√°ficos que podem ser interessantes para fins de estudo, al√©m de saber filtrar a qualidade dos dados obtidos.

<center>

[![](5635877d045a1479b7f7b07982c85b7b.jpg "P. grandiflorum"){width="428"}](https://i.pinimg.com/564x/56/35/87/5635877d045a1479b7f7b07982c85b7b.jpg)

</center>

# Acessando o banco de dados

Antes de acessar o banco de dados do GIBF precisamos instalar e acessar alguns pacotes. S√£o eles: `tidyverse`, `rgbif`, `scrubr`, `maps`, `leaflet`.

Para j√° come√ßarmos a filtrar bem nossos dados, vamos selecionar apenas ocorr√™ncias da esp√©cie que possuam coordenadas e sem problemas geoespaciais:

```{r carregando pacotes e acessando os dados}
library(tidyverse)
library(rgbif)
library(maps)

embirucu_gbif <- occ_data(scientificName = "Pseudobombax grandiflorum", 
                        hasCoordinate = TRUE,
                        hasGeospatialIssue=FALSE)
```

------------------------------------------------------------------------

<p style="color:red">**DICA!**</p>

üëâ Caso queira ver somente quantas ocorr√™ncias existem, sem precisar esperar carregar todo o dataset, podemos atribuir um limite. Por exemplo:

```{r}
especies_gbif <- occ_data(scientificName = "Pseudobombax grandiflorum",
                          hasCoordinate = TRUE,
                          hasGeospatialIssue=FALSE,
                          limit=500)
```

------------------------------------------------------------------------

Agora vamos checar as dimens√µes do dataset:

```{r tamanho do dataset}
dim(embirucu_gbif)
dim(embirucu_gbif$data)
```

Vimos que foram encontradas 283 registros de 118 vari√°veis.

Ao selecionar apenas o nosso objeto, verificamos no console que o n√∫mero de registros encontrados √© o mesmo n√∫mero de registros retornados, isto √©, 283 ap√≥s a filtragem. Logo, problemas geoespaciais e sem coordenadas n√£o foram encontrados.

Por√©m, essa filtragem nos campos de coordenadas e problemas geoespaciais √© s√≥ o come√ßo e a quantidade de ocorr√™ncias s√£o muito grandes. Precisamos avaliar a qualidade desses dados passando por uma filtragem mais refinada.

## Filtrando a qualidade dos dados

Podemos come√ßar pela filtragem do algoritmo do GBIF, individualizando os issues encontrados nas ocorr√™ncias e depois verificar que issues s√£o esses no dataset baixado:

```{r checando issues}
gbif_issues()

issues_gbif <- embirucu_gbif$data$issues %>%
  strsplit(., "[,]") %>% 
  unlist() %>%
  unique()

gbif_issues() %>%
  data.frame() %>%
  filter(code%in%issues_gbif)
```

Precisamos agora selecionar as colunas que nos interessam para verifica√ß√£o das ocorr√™ncias:

```{r}
embirucu_gbif1 <- embirucu_gbif$data %>%
  dplyr::select(scientificName, gbifID, family, taxonRank, year, decimalLatitude, decimalLongitude,
                issues, basisOfRecord, occurrenceStatus, 
                datasetName, continent, locality, habitat, institutionCode, elevation, stateProvince, individualCount)
```

J√° podemos plotar um mapa para visualizar como nossos dados est√£o dispersos. Temos duas op√ß√µes:

```{r}

map("world", xlim = range(embirucu_gbif1$decimalLongitude), ylim = range(embirucu_gbif1$decimalLatitude)) 
points(embirucu_gbif1[ , c("decimalLongitude", "decimalLatitude")], col= "red", pch = ".")
```

Podemos especificar as dire√ß√µes das coordenadas em 'xlim' e 'ylim' acima. Entretanto, tais pontos s√£o provavelmente centr√≥ides de c√©lulas de grade (relativamente grandes) nas quais pesquisas particulares foram baseadas, ent√£o lembre-se de ajustar a resolu√ß√£o espacial de sua an√°lise de acordo!

Uma outra op√ß√£o e a que iremos utilizar √©:

```{r}
mapateste <- borders("world", colour="gray50", fill="gray50")
ggplot()+ coord_fixed()+ mapateste +
  geom_point(data = embirucu_gbif1, aes(x = decimalLongitude, y = decimalLatitude),
             colour = "darkred", size = 0.5)+
  theme_bw()
```

Por esse mapa, conseguimos identificar alguns pontos fora do centro de distribui√ß√£o da esp√©cie no Brasil. Vamos, ent√£o, seguir com nossa filtragem de qualidade, verificando dados √∫nicos e checando os n√≠veis dos fatores:

```{r}
embirucu_gbif1 <- embirucu_gbif1 %>% 
  distinct()
lapply(embirucu_gbif1, unique)
```

Bom, tudo certo, aqui terminamos a filtragem de issues pelo algoritmo do gbif. Podemos ainda continuar nosso controle de qualidade dos dados a partir de investiga√ß√µes individuais. Isso ser√° necess√°rio, uma vez que os dados geralmente possuem erros, ent√£o a inspe√ß√£o precisa ser minunciosa.

O pr√≥ximo passo, ent√£o, √© verificar registros √∫nicos e remover os que possuem zeros ou s√£o ausentes :

```{r}
names(embirucu_gbif1)
sort(unique(embirucu_gbif1$individualCount))
sort(unique(embirucu_gbif1$occurrenceStatus))
```

Verificamos que n√£o tem nenhum ponto que corresponde a zero e n√£o h√° nenhuma ocorr√™ncia contendo "ausente". Entretanto, pode estar sendo exibido em outras l√≠nguas. Vamos averiguar nas l√≠nguas mais comumns para essa esp√©cie. Al√©m disso, temos que nos lembrar que o R discrimina letras mai√∫sculas de min√∫sculas:

```{r averiguando dados ausentes}
absence_rows <- which(embirucu_gbif1$individualCount == 0 | embirucu_gbif1$occurrenceStatus %in% c("absent", "Absent", "ABSENT", "ausente", "Ausente", "AUSENTE"))
length(absence_rows)
if (length(absence_rows) > 0) {
  embirucu_gbif1 <- embirucu_gbif1[-absence_rows, ]
}
```

Assim, conseguimos ver que realmente n√£o h√° ocorr√™ncias registradas como "ausente".

Nossa investiga√ß√£o de erros ou problemas nos dados n√£o pode parar por aqui. Precisamos sempre buscar meios de filtrar a qualidade dos dados baixados.

## Filtragens mais refinadas

### **Pacote `scrubr`**

Vamos realizar a filtragem agora a partir do pacote `scrubr`, investigando coordenadas incompletas, imprecisas, imposs√≠veis, improv√°veis e duplicadas:

```{r filtragem}
library(scrubr)
nrow(embirucu_gbif1)
```

Identificamos 283 ocorr√™ncias. Aplicando a filtragem das coordenadas, temos:

```{r}
embirucu_gbif1 <- coord_incomplete(coord_imprecise(coord_impossible(coord_unlikely(dedup(embirucu_gbif1)))))
nrow(embirucu_gbif1)
```

Agora temos 236 ocorr√™ncias. Foram eliminadas, ent√£o, 47 ocorr√™ncias com problemas nas coordenadas.

### **Pacote `CoordinateCleaner`**

Um outro procedimento para controle de qualidade dos dados, e muito comum, √© a utiliza√ß√£o do pacote `CoordinateCleaner`. Esse pacote possui a fun√ß√£o `clean_coordinates`, a qual envolve um grande conjunto de etapas de limpeza automatizadas para sinalizar erros comuns a cole√ß√µes biol√≥gicas.

Vamos utilizar esse pacote e marcar como flags os dados suspeitos atrav√©s de alguns testes:

```{r usando o coordinatecleaner}
library(CoordinateCleaner)

flags <- clean_coordinates(
  x = embirucu_gbif1,
  lon = "decimalLongitude",
  lat = "decimalLatitude",
  species = "scientificName",
  tests = c("equal", "gbif","zeros", "seas", "capitals", "centroids", "institutions"))

summary(flags)
plot(flags, lon = "decimalLongitude", lat = "decimalLatitude")
```

Os testes identificaram cerca de 13% de ocorr√™ncias com flags. Al√©m disso, como vemos no mapa, algumas flags est√£o distantes do centro de distribui√ß√£o geogr√°fica da esp√©cie. √â necess√°rio uma investiga√ß√£o mais profunda sobre essas ocorr√™ncias, mas por hora, vamos apenas remover essas flags para continuarmos esta atividade.

```{r dados limpos restantes}
dat_cl <- embirucu_gbif1[flags$.summary,]

#Dados marcados com flags
dat_fl <- embirucu_gbif1[!flags$.summary,]
```

Sobraram, ent√£o, 205 ocorr√™ncias filtradas. Vamos salvar esses dados.

Por fim, vamos averiguar a quantidade de registros por estado:

```{r ocorrencias por estado}
embirucu_gbif1 %>% drop_na(stateProvince) %>% count(stateProvince, sort = TRUE) %>% ggplot(aes(x = reorder(stateProvince, 
                                                                                              n), y = n, fill = stateProvince)) + geom_bar(stat = "identity", show.legend = FALSE) + 
  labs(x = "Estados", y = "N√∫mero de ocorr√™ncias") + coord_flip()
```

Como podemos ver, o estado da Bahia possui o maior registro de ocorr√™ncias da esp√©cie *Pseudobombax grandiflorum*, seguida dos estados do Rio de Janeiro e Esp√≠rito Santo. Esse tipo de gr√°fico se torna interessante para an√°lises mais profundas sobre o habitat da esp√©cie, al√©m de informar regi√µes com maior quantidade de informa√ß√µes e outras que precisam ser melhor investigadas.

# **Mapas interativos**

## **Pacote `leaflet`**

Plotamos alguns mapas do decorrer do processo para termos uma ideia da distribui√ß√£o dos dados da esp√©cie. Por√©m, esses mapas n√£o s√£o interativos. Para realizar mapas interativos e, posteriormente, passar para a vers√£o em html, podemos utilizar o pacote `leaflet`.

Os procedimentos s√£o os mesmos para filtragem de dados, selecionamos as vari√°veis a serem investigadas e plotamos o mapa como mostra o script abaixo:

```{r usando o leaflet}
library(tidyverse)
library(rgbif)

# Verificamos as ocorr√™ncias
embirucu_gbif_ok <- occ_data(scientificName = "Pseudobombax grandiflorum", 
                           hasCoordinate = TRUE,
                           hasGeospatialIssue = FALSE)
# checando alguns issues
issues_gbif <- embirucu_gbif_ok$data$issues %>% 
  unique() %>% 
  strsplit(., "[,]") %>% 
  unlist()

gbif_issues() %>% 
  data.frame() %>% 
  filter(code %in% issues_gbif)

# selecionando vari√°veis de interesse
embirucu <- embirucu_gbif_ok$data %>%
  dplyr::select(scientificName, decimalLatitude, decimalLongitude) %>% 
  distinct()

library(leaflet)

#Conferindo o mapa
embirucu %>% 
  leaflet() %>% 
  addTiles() %>% 
  addMarkers(~decimalLongitude,
             ~decimalLatitude, label = ~as.character(decimalLongitude))
```

A seguir, precisamos ajustar as configura√ß√µes do mapa, como cores da paleta, inser√ß√£o e posi√ß√£o da legenda:

```{r configurando o mapa leaflet}
pal <- colorFactor(palette = "magma", domain = unique(embirucu$scientificName))

embirucu %>% 
  leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers(~decimalLongitude,
                   ~decimalLatitude,
                   radius = 5,
                   label = ~as.character(scientificName),
                   color = ~pal(embirucu$scientificName),
                   stroke = FALSE, fillOpacity = 0.5) %>% 
  addLegend('bottomright', 
            colors = unique(pal(embirucu$scientificName)), 
            labels = unique(embirucu$scientificName),
            title = 'Esp√©cie',
            opacity = 0.5)
```

A partir desse mapa podemos ver com clareza os pontos no mapa no qual a esp√©cie possui registros de ocorr√™ncia.

## **Pacote `Plotly`**

Utilizaremos o pacote `Plotly` para averiguar a distribui√ß√£o de ocorr√™ncias em certas latitudes:

```{r}
library(plotly)


cc <- embirucu %>% 
  mutate(lat = round(decimalLatitude)) %>% 
  group_by(lat, scientificName) %>%
  summarise(occ = length(scientificName)) %>%
  ggplot(aes(y = occ, x = lat, color = scientificName)) +
  geom_point() +
  geom_smooth() +
  theme_classic() +
  labs(x = "latitude", y = 'ocorr√™ncias')

ggplotly(cc)
```

Aqui observamos que as ocorr√™ncias est√£o mais presentes em latitudes negativas, que corresponde ao Hemisf√©rio Sul, basta passar o cursor nos pontos para exibir as informa√ß√µes.

Um recurso interessante para ser utilizado nas consultas de dados abertos, √© a observa√ß√£o das tend√™ncias no registro de ocorr√™ncias atrav√©s do tempo. Usaremos o pacote `ggplot2` e o `plotly` para desenharmos um gr√°fico de linha interativo que nos mostra a quantidade de ocorr√™ncias para a esp√©cie no decorrer dos anos.

```{r registros temporais}
library(tidyverse)
library(plotly)

embirucu_gbif1 %>% count(year)

out <- embirucu_gbif1 %>% drop_na(year) %>% count(year) %>% ggplot(aes(x = year, 
                                                                   y = n, group = 1)) + xlim(1910, 2022) + geom_line()
plotly::ggplotly(out)
```

Os registros datam desde 1911 e teve maior pico em 2006, com 15 ocorr√™ncias registradas. Esse gr√°fico pode ser interessante para checar as tend√™ncias da esp√©cie e a quantidade de informa√ß√£o que possa estar dispon√≠vel no banco de dados.

------------------------------------------------------------------------

# **Refer√™ncias bibliogr√°ficas**

Carvalho, P., 2008. Embiru√ßu (*Pseudobombax grandiflorum*). Embrapa Florestas-Circular T√©cnica (INFOTECA-E).

Sultan, S.E., 2003. Phenotypic plasticity in plants: a case study in ecological development. Evolution & development, 5(1), 25-33.
